name: Build and Release

on:
  push:
    tags:
      - 'v*'
    # Only allow builds with secrets from main branch and tags
    # Forks and external PRs cannot access secrets

jobs:
  build-deps:
    runs-on: macos-15  # GitHub-hosted Apple Silicon runner
    outputs:
      cache-hit: ${{ steps.cache-check.outputs.cache-hit }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: bun install

      - name: Cache llama.cpp build
        id: cache-check
        uses: actions/cache@v4
        with:
          path: |
            llama-cli/deps/llama.cpp
          key: llama-cpp-${{ runner.os }}-${{ hashFiles('**/versions.env') }}
          restore-keys: |
            llama-cpp-${{ runner.os }}-

      - name: Cache Zig compiler
        uses: actions/cache@v4
        with:
          path: vendors/zig
          key: zig-${{ runner.os }}-${{ hashFiles('**/versions.env') }}
          restore-keys: |
            zig-${{ runner.os }}-
          # Version controlled by .github/workflows/versions.env

      - name: Build dependencies if needed
        if: steps.cache-check.outputs.cache-hit != 'true'
        run: |
          echo "Building llama.cpp dependencies..."
          bun setup

  build:
    needs: build-deps
    runs-on: macos-15  # GitHub-hosted Apple Silicon runner
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: bun install

      - name: Restore llama.cpp cache
        id: llama-cache-restore
        uses: actions/cache@v4
        with:
          path: |
            llama-cli/deps/llama.cpp
          key: llama-cpp-${{ runner.os }}-${{ hashFiles('**/versions.env') }}
          restore-keys: |
            llama-cpp-${{ runner.os }}-

      - name: Debug cache status
        run: |
          echo "Cache hit: ${{ steps.llama-cache-restore.outputs.cache-hit }}"
          echo "Cache key: llama-cpp-${{ runner.os }}-${{ hashFiles('**/versions.env') }}"
          echo "Current directory: $(pwd)"
          echo "llama.cpp exists: $(test -d llama-cli/deps/llama.cpp && echo 'yes' || echo 'no')"

      - name: Restore Zig compiler cache
        uses: actions/cache@v4
        with:
          path: vendors/zig
          key: zig-${{ runner.os }}-${{ hashFiles('**/versions.env') }}
          restore-keys: |
            zig-${{ runner.os }}-

      - name: Verify dependencies are available
        run: |
          echo "Checking for required dependencies..."
          if [ ! -f "vendors/zig/zig" ]; then
            echo "❌ Zig not found, running setup"
            bun setup
          else
            echo "✅ Zig found at vendors/zig/zig"
          fi
          
          if [ ! -f "llama-cli/deps/llama.cpp/include/llama.h" ]; then
            echo "❌ llama.h not found, running setup"
            bun setup
          else
            echo "✅ llama.h found"
          fi
          

      - name: Install Apple Certificate
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: |
          # Clean up any existing keychain from previous builds
          security delete-keychain build.keychain || true
          
          # Create temporary keychain
          echo $MACOS_CERTIFICATE | base64 --decode > certificate.p12
          security create-keychain -p actions build.keychain
          
          # Add to search list so codesign can find it
          security list-keychains -d user -s build.keychain $(security list-keychains -d user | sed s/\"//g)
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          
          # Import certificate with proper access
          security import certificate.p12 -k build.keychain -P $MACOS_CERTIFICATE_PWD -T /usr/bin/codesign -T /usr/bin/productbuild
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions build.keychain
          
          # Keep keychain unlocked for the entire session
          security set-keychain-settings -lut 21600 build.keychain
          
          # Verify certificate is accessible
          echo "Available signing identities:"
          security find-identity -v -p codesigning build.keychain
          
          rm certificate.p12

      - name: Determine build type
        id: build_type
        run: |
          if [[ "${{ github.ref }}" == *"-canary"* ]]; then
            echo "BUILD_ENV=canary" >> $GITHUB_OUTPUT
            echo "CHANNEL=canary" >> $GITHUB_OUTPUT
          else
            echo "BUILD_ENV=stable" >> $GITHUB_OUTPUT
            echo "CHANNEL=stable" >> $GITHUB_OUTPUT
          fi

      - name: Build application
        run: |
          # Mask sensitive values in logs
          echo "::add-mask::$ELECTROBUN_DEVELOPER_ID"
          echo "::add-mask::$ELECTROBUN_APPLEID" 
          echo "::add-mask::$ELECTROBUN_APPLEIDPASS"
          echo "::add-mask::$ELECTROBUN_TEAMID"
          echo "::add-mask::$MIXPANEL_TOKEN"
          
          # Run the build
          bun build:${{ steps.build_type.outputs.BUILD_ENV }}
        env:
          # Apple Developer credentials for code signing
          ELECTROBUN_DEVELOPER_ID: ${{ secrets.ELECTROBUN_DEVELOPER_ID || '' }}
          ELECTROBUN_APPLEID: ${{ secrets.ELECTROBUN_APPLEID || '' }}
          ELECTROBUN_APPLEIDPASS: ${{ secrets.ELECTROBUN_APPLEIDPASS || '' }}
          ELECTROBUN_TEAMID: ${{ secrets.ELECTROBUN_TEAMID || '' }}
          # Analytics
          MIXPANEL_TOKEN: ${{ secrets.MIXPANEL_TOKEN || '' }}          

      - name: Prepare artifacts for upload
        id: prepare_artifacts
        run: |
          # Find the artifacts directory created by electrobun
          ARTIFACTS_DIR=$(find . -type d -name "artifacts" -maxdepth 2 | head -1)
          if [ -z "$ARTIFACTS_DIR" ]; then
            echo "No artifacts directory found"
            exit 1
          fi
          echo "ARTIFACTS_DIR=$ARTIFACTS_DIR" >> $GITHUB_OUTPUT
          
          # List artifacts for debugging
          ls -la "$ARTIFACTS_DIR"

      - name: Upload to Cloudflare R2
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_RELEASES_BUCKET }}  # e.g., "colab-releases"
        run: |
          bun run scripts/upload-artifacts.ts -- "${{ steps.prepare_artifacts.outputs.ARTIFACTS_DIR }}"

      - name: Cleanup keychain
        if: always()
        run: |
          # Clean up the temporary keychain
          security delete-keychain build.keychain || true

  publish-demo-plugin:
    needs: build
    runs-on: ubuntu-latest
    # Only publish for stable releases (not canary)
    if: ${{ !contains(github.ref, '-canary') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Extract version from tag
        id: version
        run: |
          # Extract version from tag (e.g., v1.2.3 -> 1.2.3)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Update plugin version
        run: |
          cd test-plugin
          npm version ${{ steps.version.outputs.VERSION }} --no-git-tag-version --allow-same-version

      - name: Publish to npm
        run: |
          cd test-plugin
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
